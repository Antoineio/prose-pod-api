# See <https://taskfile.dev/usage> and <https://taskfile.dev/reference/schema>
# to find all keys and their usage.
version: "3"

silent: true
dotenv: [paths.env]
env:
  SELF: task {{ .ALIAS | default .TASK }} --
  SCRIPTS_ROOT: "{{.ROOT_DIR}}/scripts"
  REPOSITORY_ROOT: "{{.ROOT_DIR}}"

tasks:
  lint:
    deps: [rust:lint, openapi:lint]

  rust:lint:
    desc: Lints all Rust files.
    internal: true
    cmd: cargo fmt --check

  format:
    desc: Formats all files.
    deps: [rust:format]

  rust:format:
    desc: Formats all Rust files.
    internal: true
    cmd: cargo fmt

  update:
    desc: Updates all dependencies.
    deps: [rust:update-deps, openapi:update-redoc]

  rust:update-deps:
    desc: Updates Rust dependencies.
    internal: true
    cmds:
      - echo '[INFO] Updating Rust dependencies…'
      - rustup upgrade
      # NOTE: `cargo update` updates all workspace member crates
      - cargo update

  rust:outdated:
    desc: Checks for outdated dependencies.
    cmd: if cargo install --list | grep -q '^cargo-edit v'; then \
      echo '[INFO] Checking for outdated dependencies…'; \
      cargo upgrade --dry-run --incompatible --pinned --verbose; \
      else \
      echo '[WARN] Install `cargo upgrade` with `cargo install cargo-edit` for this script to check for outdated dependencies'; \
      fi

  build-image:
    desc: Builds the Prose Pod API Docker image. Run `task {{.TASK}} -- --help` for more info.
    cmd: "{{.ROOT_DIR}}/scripts/build-image {{.CLI_ARGS}}"

  test:
    desc: Runs all tests then updates "Tested at Rust version" in the `README`.
    cmds:
      - task: smoke-test
      - task: integration-test
      - task: util:update-tested-at-version

  smoke-test:
    desc: Runs smoke tests.
    cmd: cargo test --test behavior -- {{.CLI_ARGS}}

  integration-test:
    desc: Runs integration tests.
    env:
      # NOTE: Analytics are temporarily disabled because of [stepci/stepci#239](https://github.com/stepci/stepci/issues/239).
      STEPCI_DISABLE_ANALYTICS: true
    cmd: "{{.ROOT_DIR}}/scripts/integration-test {{.CLI_ARGS}}"

  release:
    desc: Creates a release (bumps the version number, then adds and pushes a tag).
    cmd: "{{.ROOT_DIR}}/scripts/release {{.CLI_ARGS}}"

  local:init:
    desc: Initializes a local environment allowing one to run a Prose Pod API in one command (`task local:run`).
    cmd: "{{.ROOT_DIR}}/scripts/run-locally/init {{.CLI_ARGS}}"

  local:run:
    desc: Runs a Prose Pod API.
    cmd: "{{.ROOT_DIR}}/scripts/run-locally/run {{.CLI_ARGS}}"

  local:update:
    desc: Updates the Prose Pod API and the repositories it depends on to get the latest updates.
    cmd: "{{.ROOT_DIR}}/scripts/run-locally/update {{.CLI_ARGS}}"

  local:build:
    desc: Builds the Prose Pod API and the repositories it depends on without updating the code.
    cmd: "{{.ROOT_DIR}}/scripts/run-locally/build-images {{.CLI_ARGS}}"

  local:reset:
    desc: Starts fresh with a Prose Pod API that has no data.
    prompt: This command will delete all your local Prose data, do you want to continue?
    cmd: "{{.ROOT_DIR}}/scripts/run-locally/reset {{.CLI_ARGS}}"

  openapi:lint:
    desc: Lint the OpenAPI specification file.
    cmd: "{{.ROOT_DIR}}/scripts/openapi-lint {{.CLI_ARGS}}"

  openapi:preview-docs:
    desc: Preview the OpenAPI specification file in a graphical interface.
    cmd: "{{.ROOT_DIR}}/scripts/openapi-preview-docs {{.CLI_ARGS}}"

  openapi:update-redoc:
    desc: Updates Redoc.
    vars:
      SRC: https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js
      DEST: crates/rest-api/static/api-docs/redoc.standalone.js
    cmd: wget -q '{{.SRC}}' -O '{{.DEST}}'

  util:update-tested-at-version:
    desc: Updates "Tested at Rust version" in the `README`.
    internal: true
    vars:
      RUST_VERSION:
        sh: rustc --version
    cmds:
      - cmd: "sed -i -E 's/(Tested at Rust version: `).+(`)/\\1{{.RUST_VERSION}}\\2/' README.md"
        platforms: [linux]
      - cmd: "sed -i '' -E 's/(Tested at Rust version: `).+(`)/\\1{{.RUST_VERSION}}\\2/' README.md"
        platforms: [darwin]
